<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Speaking Game üéØ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
        }

        /* Header Stats */
        .stats-bar {
            display: flex;
            justify-content: space-between;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 16px 24px;
            margin-bottom: 20px;
            color: white;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.8;
            text-transform: uppercase;
        }

        .streak-fire {
            animation: pulse 0.5s ease-in-out infinite alternate;
        }

        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }

        /* Topic Filter */
        .topic-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
        }

        .topic-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .topic-btn:hover, .topic-btn.active {
            background: white;
            color: #764ba2;
            transform: scale(1.05);
        }

        /* Card */
        .card-container {
            perspective: 1000px;
            height: 400px;
            margin-bottom: 20px;
        }

        .card {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .card.flipped {
            transform: rotateY(180deg);
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 24px;
            padding: 32px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
        }

        .card-front {
            background: white;
        }

        .card-back {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
            transform: rotateY(180deg);
            overflow-y: auto;
        }

        .card-tag {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 20px;
            align-self: flex-start;
        }

        .card-question {
            font-size: 24px;
            font-weight: 600;
            color: #333;
            line-height: 1.4;
            flex: 1;
            display: flex;
            align-items: center;
        }

        .card-hint {
            color: #888;
            font-size: 14px;
            text-align: center;
            margin-top: auto;
        }

        .card-answer {
            font-size: 16px;
            line-height: 1.7;
            color: #444;
            flex: 1;
            overflow-y: auto;
        }

        .card-answer strong {
            color: #667eea;
        }

        /* Edit Mode */
        .edit-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(102, 126, 234, 0.1);
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            color: #667eea;
            transition: all 0.3s;
        }

        .edit-btn:hover {
            background: rgba(102, 126, 234, 0.2);
        }

        .edit-textarea {
            width: 100%;
            height: 100%;
            min-height: 200px;
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 16px;
            font-size: 16px;
            line-height: 1.7;
            font-family: inherit;
            resize: none;
            outline: none;
        }

        .edit-actions {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }

        .edit-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .save-btn {
            background: #667eea;
            color: white;
        }

        .save-btn:hover {
            background: #5a6fd6;
        }

        .cancel-btn {
            background: #e4e8ec;
            color: #666;
        }

        .cancel-btn:hover {
            background: #d0d5dc;
        }

        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1001;
        }

        .toast.show {
            opacity: 1;
        }

        /* Think First Overlay */
        .think-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 10;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .think-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .think-timer {
            font-size: 72px;
            font-weight: bold;
            margin-bottom: 16px;
        }

        .think-prompt {
            font-size: 18px;
            text-align: center;
            padding: 0 32px;
            opacity: 0.9;
        }

        .think-tips {
            margin-top: 24px;
            padding: 16px 24px;
            background: rgba(255,255,255,0.15);
            border-radius: 12px;
            font-size: 14px;
            max-width: 80%;
        }

        .think-tips li {
            margin: 8px 0;
            list-style: none;
        }

        .think-tips li::before {
            content: "üí° ";
        }

        /* Key Points Checklist */
        .key-points {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
            border-left: 4px solid #4caf50;
        }

        .key-points-title {
            font-weight: 700;
            color: #2e7d32;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .key-point {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 8px 0;
            font-size: 14px;
            color: #333;
        }

        .key-point input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #4caf50;
        }

        /* Self Reflection */
        .reflection-section {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
            border-left: 4px solid #ff9800;
        }

        .reflection-title {
            font-weight: 700;
            color: #e65100;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .reflection-prompt {
            font-size: 14px;
            color: #333;
            font-style: italic;
            margin-bottom: 8px;
        }

        /* Voice Recording */
        .record-section {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            justify-content: center;
        }

        .record-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .record-btn.start {
            background: #ff4757;
            color: white;
        }

        .record-btn.start.recording {
            animation: recordPulse 1s ease-in-out infinite;
        }

        @keyframes recordPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.4); }
            50% { box-shadow: 0 0 0 15px rgba(255, 71, 87, 0); }
        }

        .record-btn.play {
            background: #2ed573;
            color: white;
        }

        .record-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Prep + Speak Phases */
        .phase-indicator {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 16px;
        }

        .phase {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            background: rgba(255,255,255,0.2);
            color: white;
            opacity: 0.5;
        }

        .phase.active {
            opacity: 1;
            background: white;
            color: #764ba2;
        }

        .phase-time {
            font-weight: bold;
        }

        /* Speaking Tips Popup */
        .speaking-tips {
            position: fixed;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 400px;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s;
            z-index: 100;
        }

        .speaking-tips.show {
            opacity: 1;
            pointer-events: auto;
        }

        .speaking-tips h4 {
            color: #667eea;
            margin-bottom: 12px;
        }

        .speaking-tips ul {
            list-style: none;
            font-size: 14px;
            color: #555;
        }

        .speaking-tips li {
            margin: 8px 0;
            padding-left: 24px;
            position: relative;
        }

        .speaking-tips li::before {
            content: "‚úì";
            position: absolute;
            left: 0;
            color: #4caf50;
            font-weight: bold;
        }

        /* Vocab Challenge Badge */
        .vocab-challenge {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .vocab-challenge-icon {
            font-size: 24px;
        }

        .vocab-challenge-text {
            font-size: 13px;
            color: #333;
        }

        .vocab-challenge-word {
            font-weight: 700;
            color: #e65100;
        }

        /* Confidence Meter */
        .confidence-meter {
            margin-top: 20px;
            text-align: center;
        }

        .confidence-label {
            font-size: 14px;
            color: white;
            margin-bottom: 12px;
            opacity: 0.9;
        }

        .confidence-options {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .confidence-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .confidence-btn:hover {
            transform: scale(1.1);
            background: rgba(255,255,255,0.2);
        }

        .confidence-btn.selected {
            border-color: white;
            background: rgba(255,255,255,0.3);
            transform: scale(1.15);
        }

        /* Timer */
        .timer-bar {
            height: 6px;
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .timer-progress {
            height: 100%;
            background: linear-gradient(90deg, #00f260, #0575e6);
            border-radius: 3px;
            transition: width 0.1s linear;
        }

        .timer-progress.warning {
            background: linear-gradient(90deg, #f7971e, #ffd200);
        }

        .timer-progress.danger {
            background: linear-gradient(90deg, #ff416c, #ff4b2b);
        }

        /* Rating Buttons */
        .rating-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .rate-btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .rate-btn.again {
            background: #ff6b6b;
            color: white;
        }

        .rate-btn.hard {
            background: #feca57;
            color: #333;
        }

        .rate-btn.good {
            background: #54a0ff;
            color: white;
        }

        .rate-btn.easy {
            background: #5f27cd;
            color: white;
        }

        /* Mode Selection */
        .mode-selection {
            text-align: center;
            padding: 60px 20px;
        }

        .mode-title {
            color: white;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .mode-subtitle {
            color: rgba(255,255,255,0.8);
            margin-bottom: 40px;
        }

        .mode-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .mode-card {
            background: white;
            border-radius: 20px;
            padding: 30px 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mode-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .mode-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .mode-name {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .mode-desc {
            font-size: 14px;
            color: #666;
        }

        /* Progress Ring */
        .progress-ring {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 80px;
            height: 80px;
        }

        .progress-ring circle {
            fill: none;
            stroke-width: 6;
        }

        .progress-ring .bg {
            stroke: rgba(255,255,255,0.2);
        }

        .progress-ring .progress {
            stroke: white;
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: center;
            transition: stroke-dashoffset 0.5s;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        /* Celebration */
        .celebration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            opacity: 0;
        }

        /* Vocab Highlight */
        .vocab-word {
            background: linear-gradient(120deg, #a8edea 0%, #fed6e3 100%);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        /* Navigation */
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .nav-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .nav-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Completion Screen */
        .completion {
            text-align: center;
            color: white;
            padding: 60px 20px;
        }

        .completion-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .completion-title {
            font-size: 36px;
            margin-bottom: 10px;
        }

        .completion-stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin: 40px 0;
        }

        .completion-stat {
            text-align: center;
        }

        .completion-stat-value {
            font-size: 48px;
            font-weight: bold;
        }

        .restart-btn {
            background: white;
            color: #764ba2;
            border: none;
            padding: 16px 40px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .restart-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        /* Memory Hook Styling */
        .memory-hook {
            background: linear-gradient(135deg, #fff9c4 0%, #ffe082 100%);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
            border-left: 4px solid #ffc107;
        }

        .memory-hook-title {
            font-weight: 700;
            color: #f57c00;
            margin-bottom: 8px;
            font-size: 14px;
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Mode Selection Screen -->
        <div id="modeScreen" class="mode-selection">
            <h1 class="mode-title">üéØ IELTS Speaking Game</h1>
            <p class="mode-subtitle">Choose your practice mode</p>
            
            <div class="mode-cards">
                <div class="mode-card" onclick="startGame('flashcard')">
                    <div class="mode-icon">üÉè</div>
                    <div class="mode-name">Flashcards</div>
                    <div class="mode-desc">Flip cards & rate yourself</div>
                </div>
                <div class="mode-card" onclick="startGame('timed')">
                    <div class="mode-icon">‚è±Ô∏è</div>
                    <div class="mode-name">IELTS Simulation</div>
                    <div class="mode-desc">1-min prep + 2-min speak</div>
                </div>
                <div class="mode-card" onclick="startGame('active')">
                    <div class="mode-icon">üß†</div>
                    <div class="mode-name">Active Recall</div>
                    <div class="mode-desc">Think first, then compare</div>
                </div>
                <div class="mode-card" onclick="startGame('vocab')">
                    <div class="mode-icon">üìö</div>
                    <div class="mode-name">Vocab Builder</div>
                    <div class="mode-desc">Learn key phrases</div>
                </div>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="gameScreen" class="hidden">
            <!-- Stats Bar -->
            <div class="stats-bar">
                <div class="stat">
                    <div class="stat-value" id="currentCard">1</div>
                    <div class="stat-label">Card</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="streak">0 <span class="streak-fire">üî•</span></div>
                    <div class="stat-label">Streak</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="score">0</div>
                    <div class="stat-label">Points</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="totalCards">50</div>
                    <div class="stat-label">Total</div>
                </div>
            </div>

            <!-- Topic Filter -->
            <div class="topic-filter" id="topicFilter"></div>

            <!-- Phase Indicator (for IELTS Simulation mode) -->
            <div class="phase-indicator hidden" id="phaseIndicator">
                <div class="phase" id="prepPhase">üìù Prep: <span class="phase-time" id="prepTime">1:00</span></div>
                <div class="phase" id="speakPhase">üé§ Speak: <span class="phase-time" id="speakTime">2:00</span></div>
            </div>

            <!-- Timer Bar (for timed mode) -->
            <div class="timer-bar hidden" id="timerBar">
                <div class="timer-progress" id="timerProgress"></div>
            </div>

            <!-- Flashcard -->
            <div class="card-container">
                <div class="card" id="flashcard" onclick="handleCardClick()">
                    <div class="card-face card-front">
                        <span class="card-tag" id="cardTag">Part 1 ‚Ä¢ Housework</span>
                        
                        <!-- Vocab Challenge (shown in active mode) -->
                        <div class="vocab-challenge hidden" id="vocabChallenge">
                            <span class="vocab-challenge-icon">üéØ</span>
                            <span class="vocab-challenge-text">Try to use: <span class="vocab-challenge-word" id="challengeWord"></span></span>
                        </div>
                        
                        <div class="card-question" id="cardQuestion">
                            Do you do any housework?
                        </div>
                        
                        <!-- Record Section -->
                        <div class="record-section hidden" id="recordSection">
                            <button class="record-btn start" id="recordBtn" onclick="event.stopPropagation(); toggleRecording()">
                                üéôÔ∏è Record Answer
                            </button>
                            <button class="record-btn play" id="playBtn" onclick="event.stopPropagation(); playRecording()" disabled>
                                ‚ñ∂Ô∏è Play Back
                            </button>
                        </div>
                        
                        <div class="card-hint" id="cardHint">üëÜ Tap to reveal answer</div>
                        
                        <!-- Think First Overlay -->
                        <div class="think-overlay" id="thinkOverlay">
                            <div class="think-timer" id="thinkTimer">30</div>
                            <div class="think-prompt">Think about your answer first!</div>
                            <ul class="think-tips">
                                <li>What's your main point?</li>
                                <li>Can you give an example?</li>
                                <li>How will you extend your answer?</li>
                            </ul>
                        </div>
                    </div>
                    <div class="card-face card-back">
                        <button class="edit-btn" onclick="event.stopPropagation(); toggleEdit()">‚úèÔ∏è Edit</button>
                        <span class="card-tag" id="cardTagBack">Part 1 ‚Ä¢ Housework</span>
                        <div class="card-answer" id="cardAnswer">
                            Sample answer will appear here...
                        </div>
                        
                        <!-- Key Points Checklist -->
                        <div class="key-points" id="keyPoints">
                            <div class="key-points-title">‚úÖ Did you include?</div>
                            <div id="keyPointsList"></div>
                        </div>
                        
                        <!-- Self Reflection -->
                        <div class="reflection-section" id="reflectionSection">
                            <div class="reflection-title">ü™û Quick Reflection</div>
                            <div class="reflection-prompt" id="reflectionPrompt"></div>
                        </div>
                        
                        <div class="edit-container hidden" id="editContainer">
                            <textarea class="edit-textarea" id="editTextarea"></textarea>
                            <div class="edit-actions">
                                <button class="cancel-btn" onclick="event.stopPropagation(); cancelEdit()">Cancel</button>
                                <button class="save-btn" onclick="event.stopPropagation(); saveEdit()">üíæ Save</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Confidence Meter (shown before rating) -->
            <div class="confidence-meter hidden" id="confidenceMeter">
                <div class="confidence-label">How confident were you speaking?</div>
                <div class="confidence-options">
                    <button class="confidence-btn" onclick="setConfidence(1)">üò∞</button>
                    <button class="confidence-btn" onclick="setConfidence(2)">üòï</button>
                    <button class="confidence-btn" onclick="setConfidence(3)">üòê</button>
                    <button class="confidence-btn" onclick="setConfidence(4)">üòä</button>
                    <button class="confidence-btn" onclick="setConfidence(5)">ü§©</button>
                </div>
            </div>

            <!-- Rating Buttons -->
            <div class="rating-buttons hidden" id="ratingButtons">
                <button class="rate-btn again" onclick="rateCard(1)">üòì Again</button>
                <button class="rate-btn hard" onclick="rateCard(2)">ü§î Hard</button>
                <button class="rate-btn good" onclick="rateCard(3)">üëç Good</button>
                <button class="rate-btn easy" onclick="rateCard(4)">üåü Easy</button>
            </div>

            <!-- Navigation -->
            <div class="nav-buttons">
                <button class="nav-btn" onclick="showModeScreen()">‚Üê Back</button>
                <button class="nav-btn" onclick="skipCard()">Skip ‚Üí</button>
            </div>
        </div>

        <!-- Completion Screen -->
        <div id="completionScreen" class="completion hidden">
            <div class="completion-icon">üéâ</div>
            <h1 class="completion-title">Session Complete!</h1>
            <div class="completion-stats">
                <div class="completion-stat">
                    <div class="completion-stat-value" id="finalScore">0</div>
                    <div class="stat-label">Points</div>
                </div>
                <div class="completion-stat">
                    <div class="completion-stat-value" id="finalStreak">0</div>
                    <div class="stat-label">Best Streak</div>
                </div>
                <div class="completion-stat">
                    <div class="completion-stat-value" id="cardsReviewed">0</div>
                    <div class="stat-label">Cards</div>
                </div>
            </div>
            <button class="restart-btn" onclick="showModeScreen()">Play Again üîÑ</button>
        </div>

        <!-- Progress Ring -->
        <div class="progress-ring" id="progressRing">
            <svg viewBox="0 0 80 80">
                <circle class="bg" cx="40" cy="40" r="35"></circle>
                <circle class="progress" cx="40" cy="40" r="35" 
                    stroke-dasharray="220" stroke-dashoffset="220" id="progressCircle"></circle>
            </svg>
            <div class="progress-text" id="progressPercent">0%</div>
        </div>
    </div>

    <!-- Celebration Container -->
    <div class="celebration" id="celebration"></div>
    
    <!-- Toast Notification -->
    <div class="toast" id="toast">Answer saved!</div>

    <!-- Speaking Tips Popup -->
    <div class="speaking-tips" id="speakingTips">
        <h4>üí° Speaking Tips</h4>
        <ul>
            <li>Answer directly, then expand</li>
            <li>Use specific examples</li>
            <li>Show your personality</li>
            <li>Connect ideas with linking words</li>
        </ul>
    </div>

    <script>
        // Vocabulary for challenges
        const challengeVocab = [
            "honestly", "definitely", "actually", "basically", "personally",
            "to be honest", "in my experience", "I'd say", "it depends",
            "for instance", "such as", "especially", "particularly"
        ];
        
        // Reflection prompts
        const reflectionPrompts = [
            "Did you give a specific example from your life?",
            "Could you extend this answer further?",
            "Did you use any advanced vocabulary?",
            "Was your answer natural and conversational?",
            "Did you express your opinion clearly?",
            "Could you add more detail or a reason?",
            "Did you speak fluently without long pauses?",
            "Did you use any idioms or collocations?"
        ];

        // IELTS Speaking Data
        const ieltsData = [
            // Housework
            { q: "Do you do any housework?", a: "Yes, I handle about half the housework at home‚Äîmostly dishes and laundry. I split the responsibilities with my family, which keeps things fair.", tag: "Part 1 ‚Ä¢ Housework", type: "question" },
            { q: "What housework do you like/dislike doing?", a: "I actually enjoy cooking, especially <span class='vocab-word'>chopping vegetables</span> after a long day of Zoom calls‚Äîit's like <span class='vocab-word'>tactile therapy</span> for me. But I really dislike ironing clothes; it feels endless and boring.", tag: "Part 1 ‚Ä¢ Housework", type: "question" },
            { q: "Did you do housework when you were a child?", a: "Not much, honestly. I'd help my mum wash dishes occasionally, but I didn't have regular chores. Looking back, I wish I'd learned these skills earlier.", tag: "Part 1 ‚Ä¢ Housework", type: "question" },
            { q: "Do you think children should do housework?", a: "Yes, definitely. <span class='vocab-word'>Age-appropriate chores</span> teach responsibility and life skills. Even simple tasks like setting the table help children understand that running a home requires everyone's effort.", tag: "Part 1 ‚Ä¢ Housework", type: "question" },
            { q: "Do you often cook at home?", a: "Pretty often. I cook a <span class='vocab-word'>batch of stew</span> on Sundays so my weekdays stay uncluttered. It's become more of a <span class='vocab-word'>self-care ritual</span> than a chore now.", tag: "Part 1 ‚Ä¢ Housework", type: "question" },
            
            // Staying at Home
            { q: "Do you spend a lot of time at home?", a: "Yes, I'm mostly a <span class='vocab-word'>homebody</span> these days. I work from home and prefer quiet evenings in, so I probably spend more time at home than the average person.", tag: "Part 1 ‚Ä¢ Staying Home", type: "question" },
            { q: "What do you like to do when you're at home?", a: "I usually read in my cozy corner or cook something relaxing. On weekends, I dedicate an <span class='vocab-word'>analog hour</span> where I put away all screens and just journal or listen to music.", tag: "Part 1 ‚Ä¢ Staying Home", type: "question" },
            { q: "Do you prefer staying at home or going out?", a: "It depends on my energy level. I'm <span class='vocab-word'>noise-sensitive</span>, so after crowded days I definitely prefer staying home. But I enjoy going out for specific purposes like meeting friends.", tag: "Part 1 ‚Ä¢ Staying Home", type: "question" },
            { q: "What's your favorite room in your home?", a: "My bedroom, definitely. I've <span class='vocab-word'>curated</span> it into a wonderland with lots of tropical plants. It's the only space that feels completely mine in our multi-generational flat.", tag: "Part 1 ‚Ä¢ Staying Home", type: "question" },
            
            // Hometown
            { q: "Where is your hometown?", a: "I'm from Guangzhou. It's famous for two things‚Äîthe amazing food culture with dim sum and seafood, and the Canton Tower. Both represent the city well‚Äîtradition and modernity mixed together.", tag: "Part 1 ‚Ä¢ Hometown", type: "question" },
            { q: "What is your hometown famous for?", a: "The city's known for its incredible food scene‚Äîdim sum, fresh seafood, traditional Cantonese cooking. There's this saying that Cantonese people will eat anything, and the restaurants here prove it.", tag: "Part 1 ‚Ä¢ Hometown", type: "question" },
            { q: "Do you like your hometown?", a: "I do, but it's complicated. I loved the food culture and the community work I did there‚Äîhelping with local projects taught me a lot. But honestly, I'm more excited about opportunities elsewhere.", tag: "Part 1 ‚Ä¢ Hometown", type: "question" },
            
            // City You Live In
            { q: "What city do you live in?", a: "I live in a megacity in the south. It's one of those places that never quite sleeps‚Äîthere's always construction, traffic, and something happening at any hour.", tag: "Part 1 ‚Ä¢ City", type: "question" },
            { q: "What do you like most about your city?", a: "I love how old warehouses blend with modern glass towers along the <span class='vocab-word'>revitalized riverfront</span>. There's this mix of grit and shine that feels authentic.", tag: "Part 1 ‚Ä¢ City", type: "question" },
            
            // Geography
            { q: "Did you study geography at school?", a: "Yes, I did. We had to memorize landforms and capitals, which felt pretty repetitive. By the time I graduated, I was honestly quite tired of the subject.", tag: "Part 1 ‚Ä¢ Geography", type: "question" },
            { q: "Do you find geography interesting now?", a: "Much more than before. I love watching short videos that explain how landscapes were formed. Understanding the 'why' behind things makes geography <span class='vocab-word'>click</span> for me now.", tag: "Part 1 ‚Ä¢ Geography", type: "question" },
            
            // Public Transport
            { q: "Do you often use public transport?", a: "Yes, almost every time I leave home. The metro is my main way to get to hospitals, parks, or restaurants because it's clean and affordable.", tag: "Part 1 ‚Ä¢ Transport", type: "question" },
            { q: "Do you prefer buses or trains?", a: "Trains, definitely. The metro is faster and more predictable, and I can usually grab a seat if I time my trip just before or after rush hour.", tag: "Part 1 ‚Ä¢ Transport", type: "question" },
            
            // Crowded Places
            { q: "Do you like crowded places?", a: "Not really. The city where I live is busy round the clock, so I'm constantly battling noise and bumping into people, which <span class='vocab-word'>drains my energy</span>.", tag: "Part 1 ‚Ä¢ Crowds", type: "question" },
            { q: "How do you feel in a crowd?", a: "Pretty exhausted, to be honest. I'm sensitive to sound, so the mix of voices and footsteps feels overwhelming. I need quiet time afterward to recover.", tag: "Part 1 ‚Ä¢ Crowds", type: "question" },
            
            // Plants & Nature
            { q: "Do you have plants at home?", a: "Yes, a couple of tiny ones on my desk and a taller one in the living room. That <span class='vocab-word'>bit of green</span> settles my nerves whenever screens tire me out.", tag: "Part 1 ‚Ä¢ Plants", type: "question" },
            { q: "Do you give plants as gifts?", a: "Yeah, pretty often. In my friend circle we carry a potted plant to housewarmings because it feels like we're delivering warmth and good fortune, not just a generic gift.", tag: "Part 1 ‚Ä¢ Plants", type: "question" },
            { q: "Do you like flowers?", a: "I love them. I'm the person who keeps fresh flowers around because they <span class='vocab-word'>lift my mood</span>, especially after a long day. They just make a space feel more alive.", tag: "Part 1 ‚Ä¢ Flowers", type: "question" },
            
            // Weather
            { q: "What's the weather like in your city?", a: "It's humid and warm most of the year, which can be exhausting. But we get <span class='vocab-word'>crisp breezes</span> in winter, and those are glorious.", tag: "Part 1 ‚Ä¢ Weather", type: "question" },
            { q: "Does weather affect your mood?", a: "Definitely. When it's too hot and sticky, I feel sluggish and unmotivated. But a clear, breezy day lifts my spirits instantly‚ÄîI'm way more productive then.", tag: "Part 1 ‚Ä¢ Weather", type: "question" },
            
            // Part 2 Topics
            { q: "Describe a quiet place you like to go.", a: "My favorite quiet place is a hidden mochi bakery I stumbled upon in Kyoto. The silence was incredible‚Äîjust the soft rhythm of mochi being shaped by hand, the occasional clink of tea cups. That experience taught me that the best quiet places aren't on any map‚Äîthey <span class='vocab-word'>reveal themselves when plans fall apart</span>.", tag: "Part 2 ‚Ä¢ Quiet Place", type: "question" },
            { q: "Describe an old object important to your family.", a: "The old object I treasure most is my grandmother's ceramic mug. Its rim is chipped, and the glaze has tiny cracks, but <span class='vocab-word'>nobody dares replace it</span>. Every chip has a story. That object taught me that <span class='vocab-word'>value comes from stories, not price tags</span>.", tag: "Part 2 ‚Ä¢ Old Object", type: "question" },
            { q: "Describe a friend's home you often visit.", a: "Linda's place is minimalist but warm‚Äîmismatched chairs, second-hand books organized by spine color. She has this <span class='vocab-word'>open-door policy</span> where I can drop by whenever I need to vent. That honesty <span class='vocab-word'>deepens the friendship</span> in ways that meeting at caf√©s never could.", tag: "Part 2 ‚Ä¢ Friend's Home", type: "question" },
            { q: "Describe a city you want to visit again.", a: "I want to revisit Kyoto. I decided to <span class='vocab-word'>ditch Google Maps</span> and explore like a local. An elderly woman drew me a hand-map with landmarks‚Äîa red mailbox here, a stone lantern there. That experience taught me that <span class='vocab-word'>getting lost is sometimes the whole point</span>.", tag: "Part 2 ‚Ä¢ City Revisit", type: "question" },
            { q: "Describe an occasion when you lost your way.", a: "In Kyoto, every narrow lane looked identical. My phone was dying. Then an elderly woman noticed me and went out of her way to help‚Äîdrawing landmarks on recycled paper. I stumbled upon a hidden mochi bakery I'd never have found otherwise.", tag: "Part 2 ‚Ä¢ Getting Lost", type: "question" },
            { q: "Describe a sports event you'd like to attend.", a: "I'd choose a women's basketball final. The <span class='vocab-word'>collective energy</span>‚Äîstrangers high-fiving after scores, holding breath during close calls‚Äîit's contagious. You have to be there to feel that kind of <span class='vocab-word'>collective joy</span>.", tag: "Part 2 ‚Ä¢ Sports Event", type: "question" },
            
            // Part 3 Topics
            { q: "Why do some people prefer quiet places?", a: "It comes down to <span class='vocab-word'>mental recharge</span>. Some people are more sensitive to sensory overload‚Äîconstant noise drains their energy. Introverts often find social noise exhausting, so they need solitude to restore their <span class='vocab-word'>emotional balance</span>.", tag: "Part 3 ‚Ä¢ Quiet Place", type: "question" },
            { q: "Why do people like collecting old things?", a: "Nostalgia is a big one‚Äîobjects connect us to memories. There's also the craftsmanship angle; older items were often built to last. Some collectors see it as <span class='vocab-word'>preserving cultural memory</span>, keeping history alive.", tag: "Part 3 ‚Ä¢ Old Objects", type: "question" },
            { q: "What makes a home welcoming to visitors?", a: "It's less about expensive furniture and more about <span class='vocab-word'>warmth</span>. Small touches matter: offering tea immediately, having comfortable seating, not making guests feel they're disrupting anything.", tag: "Part 3 ‚Ä¢ Homes", type: "question" },
            { q: "Is it better to travel to new places or revisit old favorites?", a: "No right answer‚Äîdepends what you're looking for. New places offer <span class='vocab-word'>discovery</span> and challenge assumptions. Revisiting lets you go deeper instead of skimming the surface. My view: 70% new, 30% returns.", tag: "Part 3 ‚Ä¢ Travel", type: "question" },
            { q: "Why is plastic waste a problem?", a: "It doesn't break down, so it accumulates in oceans, soil, and even our bodies as <span class='vocab-word'>microplastics</span>. Marine animals mistake it for food. The production process itself is carbon-intensive and relies on fossil fuels.", tag: "Part 3 ‚Ä¢ Environment", type: "question" },
            { q: "Should governments ban single-use plastics?", a: "In theory yes, but outright bans can backfire if alternatives aren't ready. A <span class='vocab-word'>phased approach</span> works better‚Äîstart by banning the worst offenders, then give businesses time to adapt.", tag: "Part 3 ‚Ä¢ Environment", type: "question" },
            
            // Vocab Cards
            { q: "What is 'tactile therapy'?", a: "A calming activity using hands. <br><br><strong>Example:</strong> 'Chopping vegetables after Zoom calls is my <span class='vocab-word'>tactile therapy</span>.'", tag: "Vocab ‚Ä¢ Housework", type: "vocab" },
            { q: "What is a 'batch-cook ritual'?", a: "Preparing multiple meals at once for efficiency. <br><br><strong>Example:</strong> 'I <span class='vocab-word'>batch-cook</span> stews on Sundays so weekdays stay uncluttered.'", tag: "Vocab ‚Ä¢ Housework", type: "vocab" },
            { q: "What does 'hit it off' mean?", a: "Connected immediately with someone. <br><br><strong>Example:</strong> 'We <span class='vocab-word'>hit it off</span> at a theatre show about two years ago.'", tag: "Vocab ‚Ä¢ Relationships", type: "vocab" },
            { q: "What does 'stress melted away' mean?", a: "Tension disappeared suddenly. <br><br><strong>Example:</strong> 'It was so ridiculous that my <span class='vocab-word'>stress just melted away</span>.'", tag: "Vocab ‚Ä¢ Feelings", type: "vocab" },
            { q: "What is a 'curated space'?", a: "An intentionally designed area. <br><br><strong>Example:</strong> 'I've <span class='vocab-word'>curated</span> my room into a sanctuary with soundproof curtains.'", tag: "Vocab ‚Ä¢ Home", type: "vocab" },
            { q: "What is 'megacity metabolism'?", a: "How big cities function and adapt. <br><br><strong>Example:</strong> 'The <span class='vocab-word'>metabolism</span> of a big city can still be human-centered if people speak up.'", tag: "Vocab ‚Ä¢ Urban", type: "vocab" },
            { q: "What does 'deepens the friendship' mean?", a: "Strengthens the bond between people. <br><br><strong>Example:</strong> 'That honesty <span class='vocab-word'>deepens the friendship</span> in ways that meeting at caf√©s never could.'", tag: "Vocab ‚Ä¢ Relationships", type: "vocab" },
            
            // Memory Hooks
            { q: "Memory Hook: Housework & Cooking", a: "<strong>Half ‚Üí Happy ‚Üí Habit ‚Üí Healing</strong><br><br>‚Ä¢ Half the housework ‚Üí Happy with cooking ‚Üí Habit (Sunday batch-cook) ‚Üí Healing (tactile therapy)<br><br>üß† <em>Visualize: Splitting chores, then happily chopping vegetables, then a pot of Sunday stew</em>", tag: "Memory Hook", type: "hook" },
            { q: "Memory Hook: Staying at Home", a: "<strong>Noise ‚Üí Nest ‚Üí No Screens ‚Üí New Me</strong><br><br>‚Ä¢ Noise sensitive ‚Üí Nest (curated sanctuary) ‚Üí No screens (analog hour) ‚Üí New me (reset and restored)<br><br>üß† <em>Visualize: Soundproof curtains, a cozy reading corner, putting away your phone</em>", tag: "Memory Hook", type: "hook" },
            { q: "Memory Hook: Quiet Place (Kyoto)", a: "<strong>Lost ‚Üí Lady ‚Üí Landmarks ‚Üí Lucky</strong><br><br>‚Ä¢ Lost in Kyoto ‚Üí Lady with hand-drawn map ‚Üí Landmarks (mailbox, lantern) ‚Üí Lucky find (mochi bakery)<br><br>üß† <em>Visualize: Narrow lanes, elderly woman, hidden bakery</em>", tag: "Memory Hook", type: "hook" },
            { q: "Memory Hook: Old Family Object", a: "<strong>Chip ‚Üí Cherish ‚Üí Chat</strong><br><br>‚Ä¢ Chip (porcelain mug is chipped) ‚Üí Cherish (nobody dares replace it) ‚Üí Chat (retell stories each Sunday)<br><br>üß† <em>Visualize: Grandmother's chipped mug, family passing it around, sharing memories</em>", tag: "Memory Hook", type: "hook" },
        ];

        // Game State
        let currentMode = 'flashcard';
        let currentIndex = 0;
        let score = 0;
        let streak = 0;
        let bestStreak = 0;
        let cardsReviewed = 0;
        let isFlipped = false;
        let timerInterval = null;
        let filteredCards = [...ieltsData];
        let activeTopics = new Set();
        let isEditing = false;
        let thinkTimer = null;
        let currentPhase = 'prep'; // 'prep' or 'speak'
        let mediaRecorder = null;
        let audioChunks = [];
        let recordedAudio = null;
        let isRecording = false;
        let confidenceLevel = 0;

        // DOM Elements
        const modeScreen = document.getElementById('modeScreen');
        const gameScreen = document.getElementById('gameScreen');
        const completionScreen = document.getElementById('completionScreen');
        const flashcard = document.getElementById('flashcard');
        const cardQuestion = document.getElementById('cardQuestion');
        const cardAnswer = document.getElementById('cardAnswer');
        const cardTag = document.getElementById('cardTag');
        const cardTagBack = document.getElementById('cardTagBack');
        const ratingButtons = document.getElementById('ratingButtons');
        const timerBar = document.getElementById('timerBar');
        const timerProgress = document.getElementById('timerProgress');
        const topicFilter = document.getElementById('topicFilter');
        const progressCircle = document.getElementById('progressCircle');
        const progressPercent = document.getElementById('progressPercent');
        const editContainer = document.getElementById('editContainer');
        const editTextarea = document.getElementById('editTextarea');
        const toast = document.getElementById('toast');
        const thinkOverlay = document.getElementById('thinkOverlay');
        const phaseIndicator = document.getElementById('phaseIndicator');
        const vocabChallenge = document.getElementById('vocabChallenge');
        const recordSection = document.getElementById('recordSection');
        const keyPoints = document.getElementById('keyPoints');
        const reflectionSection = document.getElementById('reflectionSection');
        const confidenceMeter = document.getElementById('confidenceMeter');
        const cardHint = document.getElementById('cardHint');

        // Initialize Topic Filter
        function initTopicFilter() {
            const topics = [...new Set(ieltsData.map(card => card.tag.split(' ‚Ä¢ ')[0]))];
            topicFilter.innerHTML = `<button class="topic-btn active" onclick="filterTopic('all')">All</button>`;
            topics.forEach(topic => {
                topicFilter.innerHTML += `<button class="topic-btn" onclick="filterTopic('${topic}')">${topic}</button>`;
            });
        }

        function filterTopic(topic) {
            document.querySelectorAll('.topic-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (topic === 'all') {
                filteredCards = [...ieltsData];
            } else {
                filteredCards = ieltsData.filter(card => card.tag.startsWith(topic));
            }
            
            currentIndex = 0;
            shuffleCards();
            updateCard();
            updateStats();
        }

        function shuffleCards() {
            for (let i = filteredCards.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [filteredCards[i], filteredCards[j]] = [filteredCards[j], filteredCards[i]];
            }
        }

        function startGame(mode) {
            currentMode = mode;
            currentIndex = 0;
            score = 0;
            streak = 0;
            cardsReviewed = 0;
            isFlipped = false;
            confidenceLevel = 0;
            
            // Filter based on mode
            if (mode === 'vocab') {
                filteredCards = ieltsData.filter(card => card.type === 'vocab' || card.type === 'hook');
            } else if (mode === 'active') {
                filteredCards = ieltsData.filter(card => card.type === 'question');
                shuffleCards();
                filteredCards = filteredCards.slice(0, 15); // 15 cards for active recall
            } else {
                filteredCards = [...ieltsData];
            }
            
            shuffleCards();
            
            modeScreen.classList.add('hidden');
            completionScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            
            // Mode-specific UI
            if (mode === 'timed') {
                timerBar.classList.remove('hidden');
                phaseIndicator.classList.remove('hidden');
                recordSection.classList.remove('hidden');
            } else {
                timerBar.classList.add('hidden');
                phaseIndicator.classList.add('hidden');
            }
            
            if (mode === 'active') {
                vocabChallenge.classList.remove('hidden');
                recordSection.classList.remove('hidden');
            } else if (mode !== 'timed') {
                vocabChallenge.classList.add('hidden');
                recordSection.classList.add('hidden');
            }
            
            initTopicFilter();
            updateCard();
            updateStats();
        }

        function showModeScreen() {
            modeScreen.classList.remove('hidden');
            gameScreen.classList.add('hidden');
            completionScreen.classList.add('hidden');
            if (timerInterval) clearInterval(timerInterval);
            if (thinkTimer) clearInterval(thinkTimer);
            if (isRecording) stopRecording();
        }

        function updateCard() {
            if (currentIndex >= filteredCards.length) {
                showCompletion();
                return;
            }
            
            const card = filteredCards[currentIndex];
            cardQuestion.textContent = card.q;
            cardAnswer.innerHTML = card.a;
            cardTag.textContent = card.tag;
            cardTagBack.textContent = card.tag;
            
            // Reset states
            isFlipped = false;
            isEditing = false;
            confidenceLevel = 0;
            flashcard.classList.remove('flipped');
            ratingButtons.classList.add('hidden');
            cardAnswer.classList.remove('hidden');
            editContainer.classList.add('hidden');
            confidenceMeter.classList.add('hidden');
            thinkOverlay.classList.remove('active');
            
            // Reset recording
            recordedAudio = null;
            document.getElementById('recordBtn').textContent = 'üéôÔ∏è Record Answer';
            document.getElementById('recordBtn').classList.remove('recording');
            document.getElementById('playBtn').disabled = true;
            
            // Mode-specific setup
            if (currentMode === 'active') {
                // Set vocab challenge word
                const randomVocab = challengeVocab[Math.floor(Math.random() * challengeVocab.length)];
                document.getElementById('challengeWord').textContent = randomVocab;
                vocabChallenge.classList.remove('hidden');
                cardHint.textContent = 'üß† Think & speak first, then tap to compare';
                
                // Start think timer
                startThinkTimer(30);
            } else if (currentMode === 'timed') {
                cardHint.textContent = 'üìù Use prep time to plan your answer';
                startIELTSTimer();
            } else {
                cardHint.textContent = 'üëÜ Tap to reveal answer';
            }
            
            // Generate key points for the answer
            generateKeyPoints(card);
            
            // Set reflection prompt
            const randomPrompt = reflectionPrompts[Math.floor(Math.random() * reflectionPrompts.length)];
            document.getElementById('reflectionPrompt').textContent = randomPrompt;
        }
        
        function handleCardClick() {
            if (currentMode === 'active' && !isFlipped) {
                // In active mode, show confidence meter first
                if (thinkOverlay.classList.contains('active')) {
                    return; // Can't flip during think time
                }
                showConfidenceMeter();
            } else {
                flipCard();
            }
        }
        
        function showConfidenceMeter() {
            confidenceMeter.classList.remove('hidden');
        }
        
        function setConfidence(level) {
            confidenceLevel = level;
            document.querySelectorAll('.confidence-btn').forEach((btn, i) => {
                btn.classList.toggle('selected', i + 1 === level);
            });
            
            // Auto flip after selecting confidence
            setTimeout(() => {
                confidenceMeter.classList.add('hidden');
                flipCard();
            }, 300);
        }
        
        function startThinkTimer(seconds) {
            thinkOverlay.classList.add('active');
            let timeLeft = seconds;
            const timerDisplay = document.getElementById('thinkTimer');
            timerDisplay.textContent = timeLeft;
            
            if (thinkTimer) clearInterval(thinkTimer);
            
            thinkTimer = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(thinkTimer);
                    thinkOverlay.classList.remove('active');
                    showToast('‚è∞ Time to speak! Record your answer');
                }
            }, 1000);
        }
        
        function startIELTSTimer() {
            currentPhase = 'prep';
            document.getElementById('prepPhase').classList.add('active');
            document.getElementById('speakPhase').classList.remove('active');
            
            let prepTime = 60; // 1 minute prep
            let speakTime = 120; // 2 minutes speak
            
            timerProgress.style.width = '100%';
            timerProgress.classList.remove('warning', 'danger');
            
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                if (currentPhase === 'prep') {
                    prepTime--;
                    document.getElementById('prepTime').textContent = formatTime(prepTime);
                    
                    const percent = (prepTime / 60) * 100;
                    timerProgress.style.width = percent + '%';
                    
                    if (prepTime <= 10) {
                        timerProgress.classList.add('warning');
                    }
                    
                    if (prepTime <= 0) {
                        currentPhase = 'speak';
                        document.getElementById('prepPhase').classList.remove('active');
                        document.getElementById('speakPhase').classList.add('active');
                        timerProgress.style.width = '100%';
                        timerProgress.classList.remove('warning');
                        showToast('üé§ Start speaking now!');
                        
                        // Show speaking tips briefly
                        document.getElementById('speakingTips').classList.add('show');
                        setTimeout(() => {
                            document.getElementById('speakingTips').classList.remove('show');
                        }, 4000);
                    }
                } else {
                    speakTime--;
                    document.getElementById('speakTime').textContent = formatTime(speakTime);
                    
                    const percent = (speakTime / 120) * 100;
                    timerProgress.style.width = percent + '%';
                    
                    if (speakTime <= 30) {
                        timerProgress.classList.add('danger');
                    } else if (speakTime <= 60) {
                        timerProgress.classList.add('warning');
                    }
                    
                    if (speakTime <= 0) {
                        clearInterval(timerInterval);
                        showToast('‚è±Ô∏è Time\'s up! Check the sample answer');
                        flipCard();
                    }
                }
            }, 1000);
        }
        
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        function generateKeyPoints(card) {
            const answer = card.a.replace(/<[^>]*>/g, ''); // Strip HTML
            const keyPointsList = document.getElementById('keyPointsList');
            
            // Extract key elements from the answer
            const points = [];
            
            if (answer.includes('example') || answer.includes('for instance') || answer.includes('like')) {
                points.push('Gave a specific example');
            }
            if (answer.includes('because') || answer.includes('so') || answer.includes('reason')) {
                points.push('Explained the reason');
            }
            if (answer.includes('I think') || answer.includes('I believe') || answer.includes('my view')) {
                points.push('Expressed personal opinion');
            }
            if (answer.length > 200) {
                points.push('Extended the answer');
            }
            
            // Add generic points
            points.push('Spoke fluently without long pauses');
            points.push('Used natural intonation');
            
            keyPointsList.innerHTML = points.map(point => `
                <label class="key-point">
                    <input type="checkbox" onclick="event.stopPropagation()">
                    <span>${point}</span>
                </label>
            `).join('');
        }
        
        // Voice Recording
        async function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                await startRecording();
            }
        }
        
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    recordedAudio = new Audio(URL.createObjectURL(audioBlob));
                    document.getElementById('playBtn').disabled = false;
                    showToast('üéôÔ∏è Recording saved! Tap play to listen');
                };
                
                mediaRecorder.start();
                isRecording = true;
                document.getElementById('recordBtn').textContent = '‚èπÔ∏è Stop';
                document.getElementById('recordBtn').classList.add('recording');
            } catch (err) {
                showToast('‚ùå Microphone access denied');
                console.error('Recording error:', err);
            }
        }
        
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                isRecording = false;
                document.getElementById('recordBtn').textContent = 'üéôÔ∏è Record Again';
                document.getElementById('recordBtn').classList.remove('recording');
            }
        }
        
        function playRecording() {
            if (recordedAudio) {
                recordedAudio.play();
            }
        }

        function flipCard() {
            if (!isFlipped && !isEditing) {
                isFlipped = true;
                flashcard.classList.add('flipped');
                ratingButtons.classList.remove('hidden');
                
                if (currentMode === 'timed' && timerInterval) {
                    clearInterval(timerInterval);
                }
            }
        }

        // Edit functionality
        function toggleEdit() {
            if (isEditing) return;
            isEditing = true;
            
            const card = filteredCards[currentIndex];
            // Strip HTML tags for editing
            const plainText = card.a.replace(/<[^>]*>/g, '');
            editTextarea.value = plainText;
            
            cardAnswer.classList.add('hidden');
            editContainer.classList.remove('hidden');
            editTextarea.focus();
        }

        function cancelEdit() {
            isEditing = false;
            cardAnswer.classList.remove('hidden');
            editContainer.classList.add('hidden');
        }

        function saveEdit() {
            const newAnswer = editTextarea.value.trim();
            if (newAnswer) {
                const card = filteredCards[currentIndex];
                card.a = newAnswer;
                
                // Also update in the original ieltsData array
                const originalIndex = ieltsData.findIndex(c => c.q === card.q);
                if (originalIndex !== -1) {
                    ieltsData[originalIndex].a = newAnswer;
                }
                
                cardAnswer.innerHTML = newAnswer;
                showToast('‚úÖ Answer saved!');
            }
            cancelEdit();
        }

        function showToast(message) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        function rateCard(rating) {
            // Points based on rating
            const points = [0, 5, 10, 15, 25][rating];
            
            // Bonus points for confidence alignment
            let bonus = 0;
            if (currentMode === 'active' && confidenceLevel > 0) {
                if (rating >= 3 && confidenceLevel >= 4) {
                    bonus = 10; // Confident and correct
                    showToast('üéØ +10 bonus for confidence!');
                } else if (rating <= 2 && confidenceLevel <= 2) {
                    bonus = 5; // Honest self-assessment
                    showToast('üí™ +5 for honest reflection!');
                }
            }
            
            score += points + bonus;
            
            // Streak logic
            if (rating >= 3) {
                streak++;
                if (streak > bestStreak) bestStreak = streak;
                if (streak % 5 === 0) {
                    celebrate();
                }
            } else {
                streak = 0;
            }
            
            // Clear timers
            if (thinkTimer) clearInterval(thinkTimer);
            if (timerInterval) clearInterval(timerInterval);
            
            cardsReviewed++;
            currentIndex++;
            updateStats();
            updateCard();
        }

        function skipCard() {
            streak = 0;
            if (thinkTimer) clearInterval(thinkTimer);
            if (timerInterval) clearInterval(timerInterval);
            if (isRecording) stopRecording();
            currentIndex++;
            updateStats();
            updateCard();
        }

        function updateStats() {
            document.getElementById('currentCard').textContent = Math.min(currentIndex + 1, filteredCards.length);
            document.getElementById('totalCards').textContent = filteredCards.length;
            document.getElementById('score').textContent = score;
            document.getElementById('streak').innerHTML = `${streak} <span class="streak-fire">${streak >= 3 ? 'üî•' : ''}</span>`;
            
            // Update progress ring
            const progress = (currentIndex / filteredCards.length) * 100;
            const offset = 220 - (220 * progress / 100);
            progressCircle.style.strokeDashoffset = offset;
            progressPercent.textContent = Math.round(progress) + '%';
        }

        function celebrate() {
            const celebration = document.getElementById('celebration');
            const colors = ['#ff6b6b', '#feca57', '#54a0ff', '#5f27cd', '#00d2d3', '#ff9ff3'];
            
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                confetti.style.animation = `fall ${1 + Math.random()}s ease-out forwards`;
                celebration.appendChild(confetti);
                
                setTimeout(() => confetti.remove(), 2000);
            }
        }

        function showCompletion() {
            gameScreen.classList.add('hidden');
            completionScreen.classList.remove('hidden');
            
            document.getElementById('finalScore').textContent = score;
            document.getElementById('finalStreak').textContent = bestStreak;
            document.getElementById('cardsReviewed').textContent = cardsReviewed;
            
            celebrate();
        }

        // Add falling animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fall {
                0% {
                    opacity: 1;
                    transform: translateY(-20px) rotate(0deg);
                }
                100% {
                    opacity: 0;
                    transform: translateY(100vh) rotate(720deg);
                }
            }
        `;
        document.head.appendChild(style);

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (gameScreen.classList.contains('hidden')) return;
            if (isEditing) {
                if (e.key === 'Escape') cancelEdit();
                if (e.key === 'Enter' && e.metaKey) saveEdit();
                return;
            }
            
            if (e.code === 'Space') {
                e.preventDefault();
                flipCard();
            } else if (e.key === '1') rateCard(1);
            else if (e.key === '2') rateCard(2);
            else if (e.key === '3') rateCard(3);
            else if (e.key === '4') rateCard(4);
            else if (e.key === 'ArrowRight') skipCard();
            else if (e.key === 'e' && isFlipped) toggleEdit();
        });
    </script>
</body>
</html>
